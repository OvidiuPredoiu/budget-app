// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  name         String?
  role         String   @default("user") // "user" or "admin"
  active       Boolean  @default(true) // Pentru soft delete
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  categories   Category[]
  budgets      Budget[]
  transactions Transaction[]
  refreshTokens RefreshToken[]
  auditLogs    AuditLog[]
  reports      Report[]
  scheduledReports ScheduledReport[]
  recurringTransactions RecurringTransaction[]
  savingsGoals SavingsGoal[]
  investments  Investment[]
  subscriptions Subscription[]
  receipts     Receipt[]
  sessions     UserSession[]
  integrations Integration[]
  permissions  UserPermissions?
  sharedBudgetsCreated SharedBudget[] @relation("SharedBudgetCreator")
  sharedBudgetMembers SharedBudgetMember[]
  sharedExpensesPaid SharedExpense[] @relation("SharedExpensePaidBy")
  sharedSettlementsFrom SharedSettlement[] @relation("SharedSettlementFrom")
  sharedSettlementsTo SharedSettlement[] @relation("SharedSettlementTo")
  sharedSettlementsCreated SharedSettlement[] @relation("SharedSettlementCreatedBy")
  apiKeys      ApiKey[]
  webhooks     Webhook[]
  webhookEvents WebhookEvent[]
  whiteLabelConfig WhiteLabelConfig?
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
}

model Category {
  id           String   @id @default(uuid())
  name         String
  color        String?
  isGlobal     Boolean  @default(false) // Template categorii globale
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  budgets      Budget[]
  transactions Transaction[]
  recurringTransactions RecurringTransaction[]
  
  @@index([userId])
  @@index([isGlobal])
}

model Budget {
  id         String   @id @default(uuid())
  name       String?
  month      String   // Format: YYYY-MM
  amount     Float
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([userId, categoryId, month])
  @@index([userId, month])
}

model Transaction {
  id            String   @id @default(uuid())
  date          DateTime
  amount        Float
  type          String   // income, expense, transfer
  paymentMethod String   // card, cash
  cardType      String?  // debit, credit, virtual
  merchant      String?
  note          String?
  categoryId    String
  category      Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goalId        String?  // Optional: link transaction to savings goal
  goal          SavingsGoal? @relation(fields: [goalId], references: [id], onDelete: SetNull)
  sharedBudgetId String?
  sharedBudget  SharedBudget? @relation(fields: [sharedBudgetId], references: [id], onDelete: SetNull)
  receipts      Receipt[]
  sharedExpenses SharedExpense[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId, date])
  @@index([userId, categoryId])
  @@index([goalId])
  @@index([sharedBudgetId])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String   // login, logout, create, update, delete
  entity    String   // user, transaction, budget, category
  entityId  String?
  details   String?  // JSON string cu detalii
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

model GlobalAlert {
  id          String   @id @default(uuid())
  type        String   // inactive_user, budget_exceeded, anomaly
  severity    String   // info, warning, critical
  title       String
  description String
  userId      String?  // DacÄƒ e specific unui user
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@index([isRead])
  @@index([createdAt])
}

// PREMIUM FEATURES

model Report {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  type        String   // monthly, yearly, custom, comparison
  startDate   DateTime
  endDate     DateTime
  format      String   // pdf, excel, json
  filters     String?  // JSON: { categoryIds, paymentMethods, types }
  generatedAt DateTime @default(now())
  fileUrl     String?  // Link towards generated file
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

model ScheduledReport {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  frequency String   // daily, weekly, monthly, yearly
  email     String
  type      String   // monthly, yearly, custom
  filters   String?  // JSON
  isActive  Boolean  @default(true)
  nextRun   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([nextRun])
}

model RecurringTransaction {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Float
  type          String   // income, expense
  paymentMethod String   // card, cash
  description   String
  categoryId    String
  category      Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  frequency     String   // daily, weekly, biweekly, monthly, yearly
  startDate     DateTime
  endDate       DateTime?
  lastRunDate   DateTime?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([isActive])
}

model SavingsGoal {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  targetAmount Float
  currentAmount Float @default(0)
  deadline    DateTime?
  color       String?
  icon        String?  // emoji or icon name
  description String?
  transactions Transaction[] // Transactions linked to this goal
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
}

model Investment {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String   // stock, crypto, real_estate, bond
  symbol          String?  // AAPL, BTC, etc
  name            String
  quantity        Float
  purchasePrice   Float
  currentPrice    Float
  currency        String   @default("USD")
  purchaseDate    DateTime
  lastUpdated     DateTime @default(now())
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
}

model Subscription {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  amount      Float
  frequency   String   // monthly, yearly
  nextBillingDate DateTime
  status      String   // active, cancelled, paused
  paymentMethod String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([nextBillingDate])
}

model Receipt {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionId String?
  transaction Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  imageUrl    String
  text        String?  // OCR extracted text
  merchant    String?
  amount      Float?
  date        DateTime?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([transactionId])
}

model UserSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ip        String
  userAgent String
  lastActive DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
}

model Integration {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // bank, payment, weather, etc
  provider  String   // stripe, wise, plaid, etc
  token     String?  // encrypted token
  refreshToken String?
  isActive  Boolean  @default(true)
  metadata  String?  // JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, provider])
  @@index([userId])
}

// USER PERMISSIONS
model UserPermissions {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic features (always true)
  dashboard       Boolean  @default(true)
  transactions    Boolean  @default(true)
  categories      Boolean  @default(true)
  
  // Additional features
  budgets         Boolean  @default(true)
  recurring       Boolean  @default(true)
  goals           Boolean  @default(true)
  investments     Boolean  @default(true)
  subscriptions   Boolean  @default(true)
  receipts        Boolean  @default(true)
  reports         Boolean  @default(true)
  insights        Boolean  @default(true)
  predictions     Boolean  @default(true)
  banking         Boolean  @default(true)
  sharedBudgets   Boolean  @default(true)
  analytics       Boolean  @default(true)
  tax             Boolean  @default(true)
  currency        Boolean  @default(true)
  developer       Boolean  @default(false)
  whiteLabel      Boolean  @default(true)
  
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
}

model SharedBudget {
  id           String   @id @default(uuid())
  name         String
  totalAmount  Float
  createdById  String
  createdBy    User     @relation("SharedBudgetCreator", fields: [createdById], references: [id], onDelete: Cascade)
  categoryIds  Json
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  members      SharedBudgetMember[]
  expenses     SharedExpense[]
  settlements  SharedSettlement[]
  transactions Transaction[]

  @@index([createdById])
}

model SharedBudgetMember {
  id        String   @id @default(uuid())
  budgetId  String
  budget    SharedBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("member")
  createdAt DateTime @default(now())

  @@unique([budgetId, userId])
  @@index([userId])
}

model SharedExpense {
  id            String   @id @default(uuid())
  budgetId      String
  budget        SharedBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  paidByUserId  String
  paidBy        User     @relation("SharedExpensePaidBy", fields: [paidByUserId], references: [id], onDelete: Cascade)
  splitAmong    Json
  amount        Float
  createdAt     DateTime @default(now())

  @@index([budgetId])
  @@index([paidByUserId])
}

model SharedSettlement {
  id          String   @id @default(uuid())
  budgetId    String
  budget      SharedBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  fromUserId  String
  toUserId    String
  fromUser    User     @relation("SharedSettlementFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser      User     @relation("SharedSettlementTo", fields: [toUserId], references: [id], onDelete: Cascade)
  amount      Float
  createdById String
  createdBy   User     @relation("SharedSettlementCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([budgetId])
  @@index([fromUserId])
  @@index([toUserId])
}

model ApiKey {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  keyHash    String   @unique
  keyPrefix  String
  keyLast4   String
  createdAt  DateTime @default(now())
  lastUsedAt DateTime?
  revokedAt  DateTime?

  @@index([userId])
}

model Webhook {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     String
  url       String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  events    WebhookEvent[]

  @@index([userId])
}

model WebhookEvent {
  id             String   @id @default(uuid())
  webhookId      String?
  webhook        Webhook? @relation(fields: [webhookId], references: [id], onDelete: SetNull)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event          String
  status         String
  statusCode     Int?
  responseTimeMs Int?
  payload        Json?
  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([event])
}

model WhiteLabelConfig {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName String?
  logo        String?
  colors      Json?
  domain      String?
  email       String?
  customDomain String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}
